<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Independence of the Seas: Eastern Caribbean History Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap');

        body {
            font-family: 'Lato', sans-serif;
            background-color: #FDFCF8; /* Warm off-white/sand */
            color: #334155;
        }

        h1, h2, h3, .serif {
            font-family: 'Playfair Display', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .tab-active {
            border-bottom: 2px solid #0F766E; /* Teal-700 */
            color: #0F766E;
            font-weight: 700;
        }

        .nav-active {
            background-color: #F0FDFA; /* Teal-50 */
            color: #0F766E; /* Teal-800 */
            font-weight: 700;
            border: 1px solid #CCFBF1;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 300px;
        }

        /* Chat UI styling */
        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        .user-message {
            background-color: #E0F2F1;
            color: #00695C;
            align-self: flex-end;
            margin-left: auto;
        }
        .ai-message {
            background-color: #F5F5F4;
            color: #44403C;
            align-self: flex-start;
            margin-right: auto;
            border-left: 4px solid #D97706;
        }
        
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
            40% { color: #333; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
            60% { text-shadow: .25em 0 0 #333, .5em 0 0 rgba(0,0,0,0);}
            80%, 100% { text-shadow: .25em 0 0 #333, .5em 0 0 #333;}
        }
    </style>
</head>
<body class="flex flex-col min-h-screen relative">

    <!-- Navbar -->
    <nav class="bg-white border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Title Block (Split Lines) -->
                <div class="flex flex-col justify-center">
                    <div class="text-lg md:text-xl text-teal-900 font-bold serif tracking-tight leading-none">Independence of the Seas</div>
                    <div class="text-sm md:text-base text-teal-600 font-semibold tracking-wide leading-none mt-1">March 8 ‚Äî 15, 2026</div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-4 ml-4">
                    <div class="hidden md:flex space-x-2">
                        <button id="nav-dashboard" onclick="switchView('dashboard')" class="nav-active text-stone-600 hover:text-teal-700 px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap transition-colors">Dashboard</button>
                        <button id="nav-ports" onclick="switchView('ports')" class="text-stone-600 hover:text-teal-700 px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap transition-colors">Port Guides</button>
                        <button id="nav-shopping" onclick="switchView('shopping')" class="text-stone-600 hover:text-teal-700 px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap transition-colors">Shopping</button>
                        <button id="nav-ship" onclick="switchView('ship')" class="text-stone-600 hover:text-teal-700 px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap transition-colors">Ship Secrets</button>
                        <button id="nav-historian" onclick="switchView('historian')" class="text-teal-700 bg-teal-50 hover:bg-teal-100 px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap border border-teal-200">Ask Historian ‚ú®</button>
                    </div>
                </div>
            </div>
             <!-- Mobile Nav Row -->
            <div class="md:hidden flex overflow-x-auto space-x-2 px-4 pb-2">
                 <button onclick="switchView('dashboard')" class="text-xs font-bold text-stone-600 whitespace-nowrap">Dashboard</button>
                 <button onclick="switchView('ports')" class="text-xs font-bold text-stone-600 whitespace-nowrap">Ports</button>
                 <button onclick="switchView('shopping')" class="text-xs font-bold text-stone-600 whitespace-nowrap">Shop</button>
                 <button onclick="switchView('ship')" class="text-xs font-bold text-stone-600 whitespace-nowrap">Ship</button>
                 <button onclick="switchView('historian')" class="text-xs font-bold text-teal-700 whitespace-nowrap">Historian</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 sm:p-8 max-w-7xl mx-auto w-full">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="space-y-8 animate-fade-in">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-stone-800 mb-2">Voyage Planner</h1>
                <p class="text-stone-500 serif italic text-lg">Eastern Caribbean ‚Ä¢ History & Culture Focus</p>
                <p class="text-sm text-stone-400 mt-1">Perfect Day at CocoCay ‚Ä¢ San Juan ‚Ä¢ Charlotte Amalie (St. Thomas)</p>
            </div>

            <!-- 2-Column Layout -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Welcome / Context -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 h-full">
                    <h2 class="text-xl font-bold text-teal-800 mb-4">Planning Your Voyage</h2>
                    <p class="text-stone-600 mb-4 leading-relaxed">
                        Welcome aboard. This tool focuses on <strong>History and Culture</strong> for your Eastern Caribbean sailing, rooted in the plantation economy and the complex history of the Transatlantic Slave Trade.
                        We've also added a dedicated <strong>Shopping</strong> guide to help you find authentic local crafts.
                    </p>
                    <div class="bg-amber-50 border-l-4 border-amber-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0 text-xl">üí°</div>
                            <div class="ml-3">
                                <p class="text-sm text-amber-800">
                                    <strong>Payment Tip:</strong> Check the "Payment" indicator on every listing. National Parks in San Juan are now cashless, while many local artisans in St. Thomas still prefer cash.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pro Tips Widget -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 flex flex-col h-full">
                    <h3 class="text-lg font-bold text-teal-700 mb-3 flex items-center">
                        <span class="bg-teal-100 p-1 rounded mr-2">‚öì</span> Pro Planning Tips
                    </h3>
                    <ul class="space-y-3 text-sm text-stone-600 flex-grow">
                        <li class="flex items-start"><span class="text-teal-500 mr-2">‚úì</span><strong>Bring Magnets:</strong> Cabin walls are metal. Use magnetic hooks for hats and itineraries.</li>
                        <li class="flex items-start"><span class="text-teal-500 mr-2">‚úì</span><strong>Book Shows Early:</strong> Reserve "Grease" and the Ice Show in the app the moment you board.</li>
                        <li class="flex items-start"><span class="text-teal-500 mr-2">‚úì</span><strong>Sea Day Breakfast:</strong> Skip the Windjammer buffet chaos; the Main Dining Room offers a calm, seated breakfast.</li>
                        <li class="flex items-start"><span class="text-teal-500 mr-2">‚úì</span><strong>App Check-in:</strong> Complete check-in 45 days out for the earliest boarding time.</li>
                        <li class="flex items-start"><span class="text-teal-500 mr-2">‚úì</span><strong>Byob:</strong> You can bring 2 bottles of wine per stateroom (carry-on only) on embarkation day.</li>
                    </ul>
                </div>
            </div>

            <!-- Trip Balance Radar & AI Analysis -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                     <h3 class="text-lg font-bold text-stone-700 mb-2">Your Trip Focus</h3>
                        <p class="text-sm text-stone-500 mb-4">
                            We analyze your selected activities to show your trip's "Vibe". 
                        </p>
                     <div class="chart-container">
                        <canvas id="vibeChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 flex flex-col">
                    <h3 class="text-lg font-bold text-stone-700 mb-2">Your Itinerary</h3>
                    <div id="itinerary-list" class="space-y-2 mt-4 flex-grow overflow-y-auto max-h-48 mb-4">
                        <!-- Selected items appear here -->
                        <p class="text-sm text-stone-400 italic">No activities selected yet. Go to Port Guides!</p>
                    </div>
                    
                    <div class="border-t border-stone-100 pt-4">
                         <button onclick="analyzeItinerary()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors">
                            <span>Analyze My Voyage with AI</span>
                            <span class="ml-2 text-lg">‚ú®</span>
                        </button>
                        <div id="ai-analysis-result" class="mt-4 p-4 bg-indigo-50 rounded-lg text-sm text-indigo-900 hidden">
                            <!-- AI Output here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PORT GUIDES VIEW -->
        <div id="view-ports" class="hidden space-y-6">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-stone-800">Port of Call Guides</h2>
                <p class="text-stone-600 mt-2">Curated for history buffs. Includes payment requirements for each site.</p>
            </div>

            <!-- Port Selector Tabs -->
            <div class="flex space-x-4 border-b border-stone-200 overflow-x-auto pb-1">
                <button onclick="switchPort('cococay')" id="tab-cococay" class="tab-active px-4 py-2 text-sm font-medium whitespace-nowrap transition-colors">Perfect Day at CocoCay</button>
                <button onclick="switchPort('sanjuan')" id="tab-sanjuan" class="text-stone-500 hover:text-stone-700 px-4 py-2 text-sm font-medium whitespace-nowrap transition-colors">San Juan, Puerto Rico</button>
                <button onclick="switchPort('stthomas')" id="tab-stthomas" class="text-stone-500 hover:text-stone-700 px-4 py-2 text-sm font-medium whitespace-nowrap transition-colors">Charlotte Amalie, St. Thomas</button>
            </div>

            <!-- Dynamic Port Content Container -->
            <div id="port-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8 pt-4">
                <!-- Content injected via JS -->
            </div>
        </div>

        <!-- SHOPPING VIEW -->
        <div id="view-shopping" class="hidden space-y-8 animate-fade-in">
             <div class="text-center mb-4">
                <h2 class="text-3xl font-bold text-stone-800">Port Shopping Guide</h2>
                <p class="text-stone-600 mt-2">Authentic crafts, duty-free tips, and payment methods.</p>
            </div>
            
            <div id="shopping-content" class="space-y-12">
                <!-- Shopping content injected via JS -->
            </div>
        </div>

        <!-- SHIP SECRETS VIEW -->
        <div id="view-ship" class="hidden space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-stone-800">Independence of the Seas: Secrets & Tips</h2>
                <p class="text-stone-600 mt-2 max-w-2xl mx-auto">
                    A Freedom-class favorite. Here are the spots most passengers miss.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Secret Spots -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                    <h3 class="text-xl font-bold text-teal-800 mb-4 flex items-center">
                        <span class="mr-2">ü§´</span> Hidden Spots
                    </h3>
                    <ul class="space-y-4" id="secrets-list">
                        <!-- JS populated -->
                    </ul>
                </div>

                <!-- Food & Dining -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                    <h3 class="text-xl font-bold text-amber-700 mb-4 flex items-center">
                        <span class="mr-2">üçΩÔ∏è</span> Dining Hacks
                    </h3>
                    <ul class="space-y-4" id="dining-list">
                        <!-- JS populated -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- ASK THE HISTORIAN VIEW -->
        <div id="view-historian" class="hidden h-[calc(100vh-140px)] flex flex-col">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-stone-800">Ask the Historian</h2>
                <p class="text-stone-600 mt-2">Powered by AI, tuned for Caribbean Colonial History.</p>
            </div>

            <div class="flex-grow bg-white border border-stone-200 rounded-xl shadow-sm overflow-hidden flex flex-col max-w-4xl mx-auto w-full">
                <!-- Chat Window -->
                <div id="chat-window" class="flex-grow p-4 overflow-y-auto space-y-4 flex flex-col bg-stone-50">
                    <div class="ai-message chat-message shadow-sm">
                        Greetings. I can advise on payment norms in local markets, the history of the Emancipation Garden, or where to buy authentic lace in San Juan. How can I help?
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 bg-white border-t border-stone-200">
                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="e.g. 'Is haggling acceptable in the Straw Market?'" 
                            class="flex-grow border border-stone-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500"
                            onkeypress="if(event.key === 'Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" class="bg-teal-700 hover:bg-teal-800 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                            Ask
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-stone-50 border-t border-stone-200 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-stone-400 text-sm">
            <p>Generated for your Mar 8, 2026 Voyage on Independence of the Seas.</p>
            <p class="mt-2">Disclaimer: AI results may vary. Tour availability and payment policies subject to change.</p>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA STORE ---
        const portData = {
            cococay: {
                title: "Perfect Day at CocoCay",
                desc: "Royal Caribbean's private island. While largely a theme park, you can find quiet spots and nature. It is about relaxation with touches of Bahamian culture.",
                excursions: [
                    {
                        id: 'coco-1',
                        title: "Chill Island Day Bed",
                        type: "Relaxation",
                        cost: 0,
                        payment: "Included",
                        desc: "Chill Island is the quieter side. Finding a lounger is free. Great for reading a book away from the waterpark noise.",
                        vendor: "Included"
                    },
                    {
                        id: 'coco-2',
                        title: "South Beach Nature Walk",
                        type: "Nature",
                        cost: 0,
                        payment: "Free",
                        desc: "Walk the long sandbar at South Beach early in the morning. You can often see stingrays and lemon sharks in the shallows.",
                        vendor: "Self-Guided"
                    },
                    {
                        id: 'coco-3',
                        title: "Bahamian Culture: Junkanoo Parade",
                        type: "Culture",
                        cost: 0,
                        payment: "Free",
                        desc: "Watch for the Junkanoo dancers near the Arrivals Plaza. A vibrant Bahamian tradition dating back to slavery.",
                        vendor: "Included Event"
                    },
                    {
                        id: 'coco-4',
                        title: "Nature Trail Walk",
                        type: "Nature",
                        cost: 0,
                        payment: "Free",
                        desc: "There is a small nature trail connecting the arrivals area to the beaches. Look for local lizards and native flora.",
                        vendor: "Self-Guided"
                    },
                    {
                        id: 'coco-5',
                        title: "Authentic Bahamian Food: Snack Shack",
                        type: "Culture",
                        cost: 0,
                        payment: "Included",
                        desc: "Skip the burger bar and go to Snack Shack for 'Fungi and Callaloo' or the Guava Cake if available.",
                        vendor: "Included"
                    },
                    {
                        id: 'coco-6',
                        title: "Coco Beach Club (Day Pass)",
                        type: "Relaxation",
                        cost: 199,
                        payment: "SeaPass Only",
                        desc: "An exclusive area with floating cabanas and an upscale restaurant. Very pricey, but offers the most secluded luxury.",
                        vendor: "Royal Caribbean"
                    }
                ],
                shopping: [
                    {
                        name: "CocoCay Straw Market",
                        desc: "Located near the arrivals plaza. Local Bahamian vendors selling woven hats, bags, and wood carvings.",
                        payment: "Cash (USD) or SeaPass",
                        icon: "üëí"
                    },
                    {
                        name: "Logo Shop",
                        desc: "Official Royal Caribbean merchandise and island-specific souvenirs.",
                        payment: "SeaPass Only",
                        icon: "üëï"
                    },
                    {
                        name: "Kiosks at Chill Island",
                        desc: "Small stalls sometimes set up near Chill Island selling local jewelry and hair braiding.",
                        payment: "Cash (USD) Preferred",
                        icon: "üíç"
                    }
                ],
                shoppingSecrets: [
                    "<strong>Bargaining:</strong> Unlike the ship, the Straw Market vendors are independent locals. Polite bargaining for cash purchases is often accepted.",
                    "<strong>Late Sales:</strong> The official logo shop on the island often puts dated merchandise on sale late in the afternoon before 'All Aboard'.",
                    "<strong>Cash vs SeaPass:</strong> While SeaPass works almost everywhere, the small independent artisans often prefer cash for small items."
                ],
                secrets: [
                    "<strong>Snack Shack Secret Sandwich:</strong> Ask for the 'Chicken Parm' (Chicken sandwich + Mozzarella sticks + Marinara).",
                    "<strong>Tram Service:</strong> The walk to South Beach is long. Use the free tram system if it's hot.",
                    "<strong>Oasis Lagoon:</strong> The swim-up bar has underwater music. It gets loud (party vibe), avoid if you want peace.",
                    "<strong>South Beach Sandbar:</strong> Walk all the way to the end of South Beach (past the floating bar) for total isolation and frequent stingray sightings.",
                    "<strong>Hidden Soft Serve:</strong> There is a soft serve machine near the Breezy Bay beach area that rarely has a line compared to Chill Grill.",
                    "<strong>Locker Showers:</strong> The showers by the lockers near the entrance/Arrivals Plaza are much larger and nicer than the ones on the ship."
                ]
            },
            sanjuan: {
                title: "San Juan, Puerto Rico",
                desc: "Founded in 1521. Key to understanding the Spanish Empire, the African Diaspora in the Caribbean, and military history.",
                excursions: [
                    {
                        id: 'sj-1',
                        title: "Castillo San Felipe del Morro",
                        type: "History",
                        cost: 10,
                        payment: "Credit Card Only",
                        desc: "The crown jewel. A 6-level citadel protecting the harbor. NPS sites are now cashless.",
                        vendor: "National Park Service"
                    },
                    {
                        id: 'sj-2',
                        title: "Castillo San Cristobal",
                        type: "History",
                        cost: 10,
                        payment: "Credit Card Only",
                        desc: "The largest Spanish fortification in the New World. Protects the land approach. Also cashless.",
                        vendor: "National Park Service"
                    },
                    {
                        id: 'sj-3',
                        title: "Museo de las Am√©ricas",
                        type: "Culture",
                        cost: 6,
                        payment: "Credit/Cash",
                        desc: "Located in the Ballaj√° Barracks. Excellent exhibit 'La Herencia Africana' detailing the slave trade and African influence.",
                        vendor: "Museum Entry"
                    },
                    {
                        id: 'sj-4',
                        title: "Casa Blanca Museum",
                        type: "History",
                        cost: 5,
                        payment: "Cash Preferred",
                        desc: "Built in 1521 for Ponce de Le√≥n. Oldest continuously occupied residence in Western Hemisphere.",
                        vendor: "Museum Entry"
                    },
                    {
                        id: 'sj-5',
                        title: "Walking Tour: Slavery & History",
                        type: "History",
                        cost: 55,
                        payment: "Credit (Online Pre-book)",
                        desc: "HIGHLY RECOMMENDED. Book via 'ToursByLocals'. Ask for a guide specializing in the 16th-19th century plantation economy.",
                        vendor: "Private / Small Group"
                    },
                    {
                        id: 'sj-6',
                        title: "Santa Maria Magdalena Cemetery",
                        type: "Culture",
                        cost: 0,
                        payment: "Free",
                        desc: "Located outside the walls of El Morro. Final resting place of many notable Puerto Ricans.",
                        vendor: "Self-Guided"
                    }
                ],
                shopping: [
                    {
                        name: "Mundo Ta√≠no",
                        desc: "Authentic Puerto Rican arts and crafts. Excellent selection of 'Vejigante' masks (traditional folklore masks).",
                        payment: "Credit & Cash",
                        icon: "üé≠"
                    },
                    {
                        name: "Calle del Cristo Outlets",
                        desc: "Factory outlets (Coach, etc.) located in historic buildings. Good prices, but check for defects.",
                        payment: "Credit & Cash",
                        icon: "üõçÔ∏è"
                    },
                    {
                        name: "Ole Puerto Rico",
                        desc: "Famous for fitted Panama hats. You get measured and they fit the hat to your head on the spot.",
                        payment: "Credit & Cash",
                        icon: "üé©"
                    },
                    {
                        name: "Butterfly People",
                        desc: "Gallery selling artwork made from real preserved butterflies. Unique and located in a beautiful colonial courtyard.",
                        payment: "Credit & Cash",
                        icon: "ü¶ã"
                    }
                ],
                shoppingSecrets: [
                    "<strong>Panama Hats:</strong> Real Panama hats take time to fit. If a shop doesn't measure your head, it's likely a mass-produced knock-off.",
                    "<strong>Coffee Beans:</strong> Buy 'Alto Grande' or 'Yaucono' beans at the local Supermax supermarket instead of souvenir shops. Same beans, half the price.",
                    "<strong>Vejigante Masks:</strong> Look for papier-m√¢ch√© masks signed by the artist. Coconut shell masks are cheaper but heavier and more fragile for travel."
                ],
                secrets: [
                    "<strong>Parque de las Palomas:</strong> A hidden pigeon park near the Cristo Chapel. Great views of the harbor and history.",
                    "<strong>La Rogativa:</strong> A stunning statue commemorating a religious procession that scared off British invaders. Quiet spot for photos.",
                    "<strong>Barrachina:</strong> They claim to have invented the Pina Colada. Touristy, but historic. The courtyard is beautiful.",
                    "<strong>Callejon de la Puerta Bandera:</strong> A very narrow, painted alleyway often missed by tourists, perfect for photos without crowds.",
                    "<strong>Save a Gato:</strong> Near the walk to El Morro, there is a cat sanctuary. You can stop and pet the cats (they are cared for by volunteers).",
                    "<strong>El Convento Hotel:</strong> You don't have to be a guest to visit the courtyard for a drink. It's a former convent (1651) and absolutely stunning."
                ]
            },
            stthomas: {
                title: "Charlotte Amalie, St. Thomas",
                desc: "Formerly the Danish West Indies (until 1917). A hub for the Transatlantic Slave Trade and later a coaling station.",
                excursions: [
                    {
                        id: 'st-1',
                        title: "Fort Christian",
                        type: "History",
                        cost: 10,
                        payment: "Cash Preferred",
                        desc: "Built 1672. The oldest standing structure in the Virgin Islands. Served as a fort, governor's residence, and prison.",
                        vendor: "Museum Entry"
                    },
                    {
                        id: 'st-2',
                        title: "Emancipation Garden",
                        type: "History",
                        cost: 0,
                        payment: "Free",
                        desc: "Site where Gov. von Scholten proclaimed emancipation of slaves in 1848. Critical African history site.",
                        vendor: "Self-Guided"
                    },
                    {
                        id: 'st-3',
                        title: "99 Steps & Blackbeard's Castle",
                        type: "History",
                        cost: 20,
                        payment: "Credit/Cash",
                        desc: "Steps built with Danish ship ballast bricks. Leads to Skytsborg Tower (1679).",
                        vendor: "Local Ticket Entry"
                    },
                    {
                        id: 'st-4',
                        title: "St. Thomas Synagogue",
                        type: "Culture",
                        cost: 5,
                        payment: "Cash Donation",
                        desc: "Second oldest in hemisphere. Sand floor symbolizes flight of Jews from Egypt and Inquisition.",
                        vendor: "Donation Entry"
                    },
                    {
                        id: 'st-5',
                        title: "Private Historical Driving Tour",
                        type: "History",
                        cost: 75,
                        payment: "Cash (often preferred) or Credit",
                        desc: "HIGHLY RECOMMENDED. Hire a private driver (e.g., 'Sunny Liston') to see plantation ruins like St. Peter Greathouse.",
                        vendor: "Private / Small Group"
                    },
                    {
                        id: 'st-6',
                        title: "Hassel Island Kayak",
                        type: "Adventure",
                        cost: 85,
                        payment: "Credit (Pre-book)",
                        desc: "Kayak to Hassel Island to hike ruins of British Napoleonic-era forts and marine railways.",
                        vendor: "VI Ecotours"
                    }
                ],
                shopping: [
                    {
                        name: "Main Street (Dronningens Gade)",
                        desc: "The famous duty-free zone. Historic Danish warehouses converted into jewelry and liquor stores.",
                        payment: "Credit & Cash",
                        icon: "üíé"
                    },
                    {
                        name: "Vendor's Plaza",
                        desc: "Outdoor market near the fort. T-shirts, knock-off bags, and some local crafts. Haggling is expected here.",
                        payment: "Cash Essential",
                        icon: "‚õ∫"
                    },
                    {
                        name: "Yacht Haven Grande",
                        desc: "Upscale shopping area near the WICO dock. High-end brands (Gucci, LV).",
                        payment: "Credit Card",
                        icon: "‚õµ"
                    },
                    {
                        name: "Mountain Top",
                        desc: "Huge souvenir shop at the top of the mountain. Famous for Banana Daiquiris. Touristy but huge selection.",
                        payment: "Credit & Cash",
                        icon: "üçå"
                    }
                ],
                shoppingSecrets: [
                    "<strong>Liquor Allowance:</strong> US citizens get a massive $1,600 duty-free allowance and can bring back 5 liters of liquor (if one is Cruzan rum) specifically from the USVI.",
                    "<strong>Electronics Warranty:</strong> Be careful with 'Duty Free' electronics. Verify they have a 'USA Warranty', not an 'International' one which may not be serviced back home.",
                    "<strong>Alley Boutiques:</strong> The best boutiques are often hidden in the historic 'passages' (alleys) between the waterfront and Main Street (e.g., Royal Dane Mall, Palm Passage)."
                ],
                secrets: [
                    "<strong>Gladys' Cafe:</strong> Located in Royal Dane Mall. Authentic local food (oxtail, fungi, callaloo) in a historic stone alleyway.",
                    "<strong>Drake's Seat:</strong> High overlook where Sir Francis Drake supposedly watched for Spanish ships. Accessible by taxi.",
                    "<strong>Camille Pissarro Building:</strong> The birthplace of the father of Impressionism is on Main Street (now a gallery/store).",
                    "<strong>Water Island Ferry:</strong> Take the $15 ferry from Crown Bay to Water Island (Honeymoon Beach) to escape the crowds entirely.",
                    "<strong>Magic Ice:</strong> A gallery made entirely of ice near the port. Sounds kitschy, but it's a refreshing break from the heat and includes a shot of rum.",
                    "<strong>Post Office Murals:</strong> Step inside the main Post Office downtown to see incredible Depression-era murals painted by Saturday Evening Post artist Stevan Dohanos."
                ]
            }
        };

        // Reorganized Secrets
        const shipSecrets = [
            { text: "Helipad Access: Go to Deck 4, walk all the way forward, climb the stairs. Best view for sail away.", icon: "üöÅ" },
            { text: "Peek-a-boo Bridge: Deck 11 forward. You can look through a window to see the Captain and officers driving the ship.", icon: "‚öì" },
            { text: "Free Sauna/Steam: In the locker rooms of the Fitness Center (Deck 11). Usually free on Freedom Class ships (check on board).", icon: "üßñ" },
            { text: "Studio B Ice Skating: Tickets are free but required. Get them as soon as you board (or on the app).", icon: "‚õ∏Ô∏è" }
        ];

        // --- STATE ---
        let selectedActivities = [];
        let charts = {};

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPort('cococay'); // Start with the first stop
            renderShopping();
            renderShipSecrets();
            initCharts();
            updateDashboard();
        });

        // --- BACKEND API HANDLERS ---
        async function callGemini(prompt, systemInstruction = "") {
            try {
                // Point to the Vercel API route
                const response = await fetch('/api/chat', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error(error);
                return "Sorry, I couldn't reach the historian right now. Please try again later.";
            }
        }

        async function playTTS(text) {
             try {
                const cleanText = text.replace(/<[^>]*>?/gm, ''); 
                
                // Point to the Vercel API route
                const response = await fetch('/api/tts', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: cleanText }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Aoede" } 
                                }
                            }
                        }
                    })
                });

                if (!response.ok) throw new Error('TTS API Error');
                const data = await response.json();
                const audioContent = data.candidates[0].content.parts[0].inlineData.data;
                const wavUrl = getWavUrl(audioContent);
                const audio = new Audio(wavUrl);
                audio.play();

            } catch (error) {
                console.error("TTS Error:", error);
                alert("Could not generate audio at this time.");
            }
        }

        // --- WAV CONVERSION HELPERS ---
        function getWavUrl(base64PCM) {
            const pcmData = atob(base64PCM);
            const arrayBuffer = new ArrayBuffer(pcmData.length);
            const view = new Uint8Array(arrayBuffer);
            for (let i = 0; i < pcmData.length; i++) {
                view[i] = pcmData.charCodeAt(i);
            }
            const wavHeader = createWavHeader(view.length, 24000, 1, 16); 
            const wavBlob = new Blob([wavHeader, view], { type: 'audio/wav' });
            return URL.createObjectURL(wavBlob);
        }

        function createWavHeader(dataLength, sampleRate, numChannels, bitsPerSample) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true);
            view.setUint16(32, numChannels * (bitsPerSample / 8), true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            return header;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }


        // --- FEATURE 1: ANALYZE ITINERARY ---
        async function analyzeItinerary() {
            const resultDiv = document.getElementById('ai-analysis-result');
            const btn = document.querySelector('button[onclick="analyzeItinerary()"]');
            
            if (selectedActivities.length === 0) {
                resultDiv.innerHTML = "Please select at least one activity from the Port Guides first.";
                resultDiv.classList.remove('hidden');
                return;
            }

            resultDiv.innerHTML = "<span class='loading-dots'>Consulting the Historian</span>";
            resultDiv.classList.remove('hidden');
            btn.disabled = true;

            const planSummary = selectedActivities.map(a => `${a.title} (${a.type})`).join(", ");
            const prompt = `I am planning a cruise to the Eastern Caribbean (San Juan, St. Thomas, CocoCay). My current selected activities are: ${planSummary}. 
            Acting as a strict but encouraging history professor, analyze this list. 
            1. Give it a grade (A-F) for Cultural Depth. 
            2. Tell me one major historical era or concept I am missing based on this list (e.g. 1848 Emancipation, Spanish defense).
            3. Give me one logistical warning specifically for San Juan or St. Thomas.
            Keep it under 100 words.`;

            const response = await callGemini(prompt);
            const formatted = response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            resultDiv.innerHTML = `<h4 class="font-bold mb-2">Historian's Report Card:</h4><p class="leading-relaxed">${formatted}</p>`;
            btn.disabled = false;
        }

        // --- FEATURE 2: CHAT ---
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const window = document.getElementById('chat-window');
            const text = input.value.trim();
            if (!text) return;

            // Add User Message
            window.innerHTML += `<div class="user-message chat-message shadow-sm">${text}</div>`;
            input.value = '';
            window.scrollTop = window.scrollHeight;

            // Add Loading
            const loadingId = 'loading-' + Date.now();
            window.innerHTML += `<div id="${loadingId}" class="ai-message chat-message shadow-sm loading-dots">Thinking</div>`;
            window.scrollTop = window.scrollHeight;

            const systemPrompt = "You are an expert Caribbean historian and cruise guide focusing on San Juan, St. Thomas, and CocoCay. Focus on history (Spanish forts, Danish influence, Plantation Economy, Slave Trade), culture, shopping payment methods, and hidden gems. Avoid generic tourist advice. Keep answers conversational and under 3 sentences.";
            const response = await callGemini(text, systemPrompt);

            // Replace Loading with Response
            const loader = document.getElementById(loadingId);
            loader.innerHTML = response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            loader.classList.remove('loading-dots');
            window.scrollTop = window.scrollHeight;
        }


        // --- NAVIGATION LOGIC ---
        function switchView(viewName) {
            // Hide all views
            ['dashboard', 'ports', 'shopping', 'ship', 'historian'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if(el) el.classList.add('hidden');
            });
            // Show selected view
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Update Navbar State
            ['dashboard', 'ports', 'shopping', 'ship', 'historian'].forEach(v => {
                const btn = document.getElementById(`nav-${v}`);
                if (v === viewName) {
                    btn.className = "nav-active text-stone-600 hover:text-teal-700 px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap transition-colors";
                } else {
                    btn.className = "text-stone-600 hover:text-teal-700 px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap transition-colors";
                }
            });

            if(viewName === 'dashboard') updateDashboard(); 
        }

        function switchPort(portName) {
            const tabs = document.querySelectorAll('[id^="tab-"]');
            tabs.forEach(t => {
                t.className = "text-stone-500 hover:text-stone-700 px-4 py-2 text-sm font-medium whitespace-nowrap transition-colors";
            });
            document.getElementById(`tab-${portName}`).className = "tab-active px-4 py-2 text-sm font-medium whitespace-nowrap transition-colors";
            renderPort(portName);
        }

        // --- RENDER FUNCTIONS ---
        function renderShopping() {
             const container = document.getElementById('shopping-content');
             let html = '';

             ['cococay', 'sanjuan', 'stthomas'].forEach(key => {
                 const port = portData[key];
                 const shopsHtml = port.shopping.map(s => `
                    <div class="bg-white p-4 rounded-lg border border-stone-200 card-hover">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">${s.icon}</span>
                            <div>
                                <h4 class="font-bold text-stone-800">${s.name}</h4>
                                <span class="text-xs font-semibold bg-teal-50 text-teal-800 px-2 py-0.5 rounded border border-teal-100">
                                    Payment: ${s.payment}
                                </span>
                            </div>
                        </div>
                        <p class="text-sm text-stone-600 mt-2">${s.desc}</p>
                    </div>
                 `).join('');
                 
                 const secretsHtml = port.shoppingSecrets ? `
                    <div class="col-span-1 md:col-span-2 lg:col-span-4 mt-4 bg-amber-50 p-4 rounded-lg border border-amber-100">
                        <h4 class="font-bold text-amber-800 mb-2 flex items-center"><span class="mr-2">ü§´</span> Shopping Secrets</h4>
                        <ul class="list-disc list-inside text-sm text-stone-700 space-y-1">
                            ${port.shoppingSecrets.map(sec => `<li>${sec}</li>`).join('')}
                        </ul>
                    </div>
                 ` : '';

                 html += `
                    <div>
                        <h3 class="text-xl font-bold text-teal-900 mb-4 border-b border-stone-200 pb-2">${port.title}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${shopsHtml}
                            ${secretsHtml}
                        </div>
                    </div>
                 `;
             });

             container.innerHTML = html;
        }


        function renderPort(portKey) {
            const data = portData[portKey];
            const container = document.getElementById('port-content');
            
            let excursionsHTML = data.excursions.map(ex => {
                const isAdded = selectedActivities.find(a => a.id === ex.id);
                const safeTitle = ex.title.replace(/'/g, "\\'");
                
                return `
                <div class="border border-stone-100 rounded-lg p-4 bg-stone-50 hover:bg-white card-hover flex flex-col h-full">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-bold text-teal-800 leading-tight">${ex.title}</h4>
                        <span class="text-[10px] font-semibold bg-stone-200 text-stone-600 px-2 py-1 rounded ml-2 whitespace-nowrap">${ex.type}</span>
                    </div>
                    <div class="mb-2">
                         <span class="text-[10px] font-bold text-amber-700 bg-amber-50 px-2 py-0.5 rounded border border-amber-100">üí≥ ${ex.payment}</span>
                    </div>
                    <p class="text-sm text-stone-600 flex-grow">${ex.desc}</p>
                    <div class="mt-4 pt-2 border-t border-stone-100">
                        <div class="flex justify-between items-center text-sm mb-2">
                            <span class="text-stone-500 font-mono">$${ex.cost} est.</span>
                            <button onclick="toggleActivity('${ex.id}', '${safeTitle}', ${ex.cost}, '${ex.type}')" 
                                    class="${isAdded ? 'bg-red-100 text-red-700' : 'bg-teal-100 text-teal-700'} px-3 py-1 rounded hover:opacity-80 transition-colors text-xs font-bold uppercase tracking-wider">
                                ${isAdded ? 'Remove' : 'Add to Plan'}
                            </button>
                        </div>
                        <p class="text-xs text-stone-400 italic">Recommended: ${ex.vendor}</p>
                    </div>
                </div>`;
            }).join('');

            let secretsHTML = data.secrets.map(s => `
                <li class="flex items-start">
                    <span class="text-amber-500 mr-2">‚ú¶</span>
                    <span class="text-sm text-stone-600">${s}</span>
                </li>
            `).join('');

            let cautionHTML = '';
            if (portKey === 'sanjuan') {
                cautionHTML = `
                <div class="mb-4 p-3 bg-red-50 border-l-4 border-red-500 text-red-800 text-sm rounded-r">
                    <strong>‚ö†Ô∏è Fort Warning:</strong> Do not underestimate the severe distance, heat exposure, and time required to adequately cover both <em>El Morro</em> and <em>San Cristobal</em>. Plan for transportation between them.
                </div>`;
            }

            container.innerHTML = `
                <!-- Left Col: Intro & Excursions -->
                <div class="col-span-1 lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl border border-stone-200">
                        <div class="flex justify-between items-start">
                            <h3 class="text-2xl font-bold text-stone-800 mb-2">${data.title}</h3>
                            <button onclick="playTTS('${data.desc.replace(/'/g, "\\'")}')" class="text-teal-600 hover:text-teal-800 text-sm flex items-center bg-teal-50 px-3 py-1 rounded-full transition-colors">
                                <span class="mr-1">üéß</span> Listen to History
                            </button>
                        </div>
                        <p class="text-stone-600 leading-relaxed">${data.desc}</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-stone-700 mb-4">Recommended History & Culture</h3>
                        ${cautionHTML}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${excursionsHTML}
                        </div>
                    </div>
                </div>

                <!-- Right Col: Secrets & Logistics -->
                <div class="col-span-1 space-y-6">
                    <div class="bg-amber-50 p-6 rounded-xl border border-amber-100">
                        <h3 class="text-lg font-bold text-amber-900 mb-3">Local Secrets</h3>
                        <ul class="space-y-3">
                            ${secretsHTML}
                        </ul>
                    </div>
                    <div class="bg-teal-50 p-6 rounded-xl border border-teal-100">
                        <h3 class="text-lg font-bold text-teal-900 mb-3">Logistics</h3>
                        <ul class="text-sm text-teal-800 space-y-2">
                            <li><strong>Wear Walking Shoes:</strong> San Juan and St. Thomas both involve cobblestones and hills/stairs.</li>
                            <li><strong>Currency:</strong> Both use US Dollars (PR is US, USVI is US).</li>
                            <li><strong>San Juan Trolley:</strong> There is a free trolley, but it is often very crowded. Walking is reliable.</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderShipSecrets() {
            const list = document.getElementById('secrets-list');
            list.innerHTML = shipSecrets.map(s => `
                <li class="flex items-start p-3 bg-stone-50 rounded-lg">
                    <span class="text-2xl mr-3">${s.icon}</span>
                    <span class="text-stone-700 text-sm">${s.text}</span>
                </li>
            `).join('');

            document.getElementById('dining-list').innerHTML = `
                <li class="flex items-start p-3 bg-stone-50 rounded-lg">
                    <span class="text-2xl mr-3">üçï</span>
                    <span class="text-stone-700 text-sm"><strong>Promenade Cafe:</strong> Open 24h. The late-night pizza is a cruise staple. Also free coffee/tea 24/7.</span>
                </li>
                <li class="flex items-start p-3 bg-stone-50 rounded-lg">
                    <span class="text-2xl mr-3">üêü</span>
                    <span class="text-stone-700 text-sm"><strong>Fish & Ships:</strong> Poolside fish and chips (extra fee but small). Try the deep-fried candy bar.</span>
                </li>
                <li class="flex items-start p-3 bg-stone-50 rounded-lg">
                    <span class="text-2xl mr-3">üç∞</span>
                    <span class="text-stone-700 text-sm"><strong>Main Dining Room Lunch:</strong> On sea days, the MDR lunch is excellent (salad bar + plated) and much quieter than the Windjammer buffet.</span>
                </li>
                <li class="flex items-start p-3 bg-stone-50 rounded-lg">
                    <span class="text-2xl mr-3">üç¶</span>
                    <span class="text-stone-700 text-sm"><strong>Sprinkles:</strong> Self-serve ice cream on the pool deck. Often hidden near the main pool bar.</span>
                </li>
            `;
        }

        function toggleActivity(id, title, cost, type) {
            const index = selectedActivities.findIndex(a => a.id === id);
            if (index > -1) {
                selectedActivities.splice(index, 1);
            } else {
                selectedActivities.push({ id, title, cost, type });
            }
            // Re-render current view to update button state
            const currentPort = document.querySelector('.tab-active').id.replace('tab-', '');
            renderPort(currentPort);
            updateDashboard();
        }

        // --- DASHBOARD UPDATES ---
        function updateDashboard() {
            // Update List
            const list = document.getElementById('itinerary-list');
            if (selectedActivities.length === 0) {
                list.innerHTML = '<p class="text-sm text-stone-400 italic">No activities selected yet. Explore the Port Guides to plan!</p>';
            } else {
                list.innerHTML = selectedActivities.map(a => `
                    <div class="flex justify-between items-center text-sm border-b border-stone-100 py-2">
                        <span class="text-stone-700 truncate mr-2">${a.title}</span>
                        <span class="font-mono text-stone-500">$${a.cost}</span>
                    </div>
                `).join('');
                
                // Add Total
                const total = selectedActivities.reduce((sum, a) => sum + a.cost, 0);
                list.innerHTML += `<div class="flex justify-between items-center font-bold text-teal-800 mt-2 pt-2"><span>Total Est.</span><span>$${total}</span></div>`;
            }

            // Update Charts
            updateCharts();
        }

        function initCharts() {
            // Vibe Chart (Budget Chart Removed)
            const ctxVibe = document.getElementById('vibeChart').getContext('2d');
            charts.vibe = new Chart(ctxVibe, {
                type: 'radar',
                data: {
                    labels: ['History', 'Culture', 'Relaxation', 'Nature', 'Adventure'],
                    datasets: [{
                        label: 'Trip Balance',
                        data: [20, 20, 40, 10, 10], // Base line
                        backgroundColor: 'rgba(217, 119, 6, 0.2)',
                        borderColor: '#D97706',
                        pointBackgroundColor: '#D97706'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            suggestedMax: 100,
                            ticks: { display: false }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (!charts.vibe) return;

            // Calc Vibe
            let vibeCounts = { History: 20, Culture: 20, Relaxation: 20, Nature: 10, Adventure: 10 };
            selectedActivities.forEach(a => {
                if(vibeCounts[a.type] !== undefined) vibeCounts[a.type] += 25;
            });
            charts.vibe.data.datasets[0].data = Object.values(vibeCounts);
            charts.vibe.update();
        }

    </script>
</body>
</html>